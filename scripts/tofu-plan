#!/bin/bash
# Run tofu plan across all services. Used in the tofu-plan and tofu-apply workflows.

temp_plan_out=$(mktemp)

# Set temp file for summary if not running in github actions
if [ -z "$GITHUB_STEP_SUMMARY" ]; then
  temp_summary=$(mktemp)
  echo "Setting GITHUB_STEP_SUMMARY to $temp_summary"
  GITHUB_STEP_SUMMARY="$temp_summary"
fi

if [ -n "$GITHUB_RUN_ID" ]; then
  echo "[View log for this run](https://github.com/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID)" >> $GITHUB_STEP_SUMMARY
fi

repo_root="$(git rev-parse --show-toplevel)"
tofu_error=false
for dir in $(ls "$repo_root/terraform/services"); do
  cd "$repo_root/terraform/services/$dir"
  [ ! -f "conf.sh" ] && echo "Skipping $dir service due to no conf.sh file" && continue
  set -a
  source conf.sh
  set +a
  case "$TARGET_ENVS" in
    all)
      echo "Planning $dir service because it exists in all environments, including $APP-$ENV"
      ;;
    account)
      if [[ "$APP" == "bcda" && ("$ENV" == "test" || "$ENV" == "prod") ]]; then
        echo "Planning $dir service for the account-wide $APP-$ENV environment"
      else
        echo "Skipping $dir service because $APP-$ENV is not an account-wide environment"
        continue
      fi
      ;;
    *)
      in_set=false
      for infra_env in $TARGET_ENVS; do
        if [ "$infra_env" == "$APP-$ENV" ]; then
          in_set=true
        fi
      done
      if [ "$in_set" == true ]; then
        echo "Planning $dir service because $APP-$ENV is in the set"
      else
        echo "Skipping $dir service because $APP-$ENV is not in the set"
        continue
      fi
      ;;
  esac
  echo "::group::$dir tofu"
  if ! tofu init -reconfigure -backend-config="../../backends/${APP}-${ENV}.s3.tfbackend"; then
    tofu_error=true
    echo ":exclamation: Error in init for $dir service on $APP-$ENV env." >> $GITHUB_STEP_SUMMARY
    echo "::endgroup::"
    continue
  fi
  export TF_VAR_app="$APP"
  export TF_VAR_env="$ENV"
  apply_needed=false
  if tofu plan -detailed-exitcode -out "$temp_plan_out"; then
    echo ":white_check_mark: No changes in $dir service on $APP-$ENV env." >> $GITHUB_STEP_SUMMARY
  elif [ "$?" -eq "1" ]; then
    tofu_error=true
    echo ":exclamation: Error in plan for $dir service on $APP-$ENV env." >> $GITHUB_STEP_SUMMARY
  else # Detailed exit code is 2, meaning changes are planned
    apply_needed=true
    echo ":pencil: Changes in $dir service on $APP-$ENV env. See plan." >> $GITHUB_STEP_SUMMARY
  fi
  if [[ "$apply_needed" == "true" && "$APPLY" == "true" ]]; then
    echo "Applying plan for $dir"
    if tofu apply "$temp_plan_out"; then
      echo ":rocket: Successful apply of $dir service on $APP-$ENV env." >> $GITHUB_STEP_SUMMARY
    else
      tofu_error=true
      echo ":exclamation: Error in apply of $dir service on $APP-$ENV env." >> $GITHUB_STEP_SUMMARY
    fi
  fi
  echo "::endgroup::"
done

# Reference summary again if running locally
if [ -n "$temp_summary" ]; then
  echo "See summary at $temp_summary"
fi

if [ "$tofu_error" == "true" ]; then
  exit 1
fi
