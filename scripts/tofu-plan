#!/bin/bash
# Run tofu plan across all services. Used in the tofu-plan and tofu-apply workflows.
set -e

temp_plan=$(mktemp)
temp_plan_out=$(mktemp)

# Set temp file for summary if not running in github actions
if [ -z "$GITHUB_STEP_SUMMARY" ]; then
  temp_summary=$(mktemp)
  echo "Setting GITHUB_STEP_SUMMARY to $temp_summary"
  GITHUB_STEP_SUMMARY="$temp_summary"
fi

tofu_error=false

repo_root="$(git rev-parse --show-toplevel)"
cd "$repo_root"
for dir in $(ls terraform/services); do
  cd "$repo_root/terraform/services/$dir"
  [ ! -f "conf.sh" ] && echo "Skipping $dir service due to no conf.sh file" && continue
  set -a
  source conf.sh
  set +a
  case "$TARGET_ENVS" in
    all)
      echo "Planning $dir service because it exists in all environments, including $APP-$ENV"
      ;;
    account)
      if [[ "$APP" == "bcda" && ("$ENV" == "test" || "$ENV" == "prod") ]]; then
        echo "Planning $dir service for the account-wide $APP-$ENV environment"
      else
        echo "Skipping $dir service because $APP-$ENV is not an account-wide environment"
        continue
      fi
      ;;
    *)
      in_set=false
      for infra_env in $TARGET_ENVS; do
        if [ "$infra_env" == "$APP-$ENV" ]; then
          in_set=true
        fi
      done
      if [ "$in_set" == true ]; then
        echo "Planning $dir service because $APP-$ENV is in the set"
      else
        echo "Skipping $dir service because $APP-$ENV is not in the set"
        continue
      fi
      ;;
  esac
  if ! tofu init -reconfigure -backend-config="../../backends/${APP}-${ENV}.s3.tfbackend"; then
    tofu_error=true
    echo ":exclamation: Error in init for $dir service on $APP-$ENV env." >> $GITHUB_STEP_SUMMARY
    continue
  fi
  export TF_VAR_app="$APP"
  export TF_VAR_env="$ENV"
  tofu plan -out "$temp_plan_out" | tee "$temp_plan"
  if grep "Your infrastructure matches the configuration." "$temp_plan"; then
    echo ":white_check_mark: No changes in $dir service on $APP-$ENV env." >> $GITHUB_STEP_SUMMARY
    continue
  elif grep "OpenTofu encountered an error while generating this plan." "$temp_plan"; then
    tofu_error=true
    echo ":exclamation: Error in plan for $dir service on $APP-$ENV env." >> $GITHUB_STEP_SUMMARY
    continue
  else
    echo ":pencil: Changes in $dir service on $APP-$ENV env. See plan." >> $GITHUB_STEP_SUMMARY
  fi
  if [ "$APPLY" == "true" ]; then
    echo "Applying plan for $dir"
    if tofu apply "$temp_plan_out"; then
      echo ":rocket: Successful apply of $dir service on $APP-$ENV env." >> $GITHUB_STEP_SUMMARY
    else
      tofu_error=true
      echo ":exclamation: Error in apply of $dir service on $APP-$ENV env." >> $GITHUB_STEP_SUMMARY
    fi
  fi
done

# Reference summary again if running locally
if [ -n "$temp_summary" ]; then
  echo "See summary at $temp_summary"
fi

if [ "$tofu_error" == "true" ]; then
  exit 1
fi
