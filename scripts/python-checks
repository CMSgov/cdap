#!/bin/bash
# Run checks on python files from git diff. Used in the python-checks workflow.
set -e

# When run on main, diff against the prior commit. When run on any
# other branch, diff against main.
ref="$([ "$(git branch --show-current)" == "main" ] && echo "HEAD^" || echo "main")"
echo "Using $ref for diff"

# Run checks in all affected python directories.
diff_dirs="$(git diff --name-only "$ref" -- '*.py' | xargs dirname | sort | uniq)"
repo_root="$(git rev-parse --show-toplevel)"
for dir in $diff_dirs; do
  cd "$repo_root"
  [ ! -d "$dir" ] && echo "No directory found at $dir. Skipping" && continue
  cd "$dir"
  temp_venv=$(mktemp -d)
  python -m venv "$temp_venv"
  source "$temp_venv/bin/activate"
  [ -f "requirements.txt" ] && pip install -r requirements.txt
  pip install pylint pytest
  echo "Running python lint and test on \"$dir\""
  pylint .
  pytest .
done
